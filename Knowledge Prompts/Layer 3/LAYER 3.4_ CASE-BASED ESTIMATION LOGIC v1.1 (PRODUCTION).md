# LAYER 3.4: CASE-BASED ESTIMATION LOGIC v1.1 (PRODUCTION)

**版本**: 1.0  
**狀態**: PRODUCTION  
**最後更新**: 2026-02-06  
**用途**: 定義完整的案例庫估算流程，整合特性提取、相似度匹配和調整因子應用

---

## 目錄

1. [簡介](#簡介)
2. [完整估算流程](#完整估算流程)
3. [置信度等級的估算策略](#置信度等級的估算策略)
4. [流程圖](#流程圖)
5. [實施檢查清單](#實施檢查清單)

---

## 簡介

### 目的

案例庫估算邏輯定義了完整的估算流程，從新項目特性提取開始，到最終估算結果生成。這個流程整合了：

1. **LAYER 3.1**: 特性提取
2. **LAYER 3.2**: 相似度匹配
3. **LAYER 3.3**: 調整因子應用

### 核心流程

```
新項目 → 特性提取 → 相似度匹配 → 選擇參考案例 → 應用調整因子 → 最終估算
```

---

## 完整估算流程

### Phase 1: 新項目特性提取

**目標**: 提取新項目的 6 類特性

**步驟**:

1. **收集項目文件**
   - [ ] Basis of Design (BOD)
   - [ ] 地點信息 (州、市、縣、ZIP)
   - [ ] 建築面積
   - [ ] 工期
   - [ ] 其他相關文件

2. **提取基本特性**
   - [ ] 項目名稱
   - [ ] 項目類型 (Healthcare / Warehouse / Commercial)
   - [ ] 設施類型
   - [ ] 位置信息
   - [ ] 建築面積
   - [ ] 工期

3. **提取成本特性** (如果有歷史數據)
   - [ ] 預期成本範圍
   - [ ] 成本/SF 基準
   - [ ] 成本結構假設

4. **提取改造特性**
   - [ ] 項目類型 (新建 / 改造 / 自適應重用)
   - [ ] 改造等級 (如果適用)
   - [ ] MEP 重用因子
   - [ ] 現有建築狀況

5. **提取地區特性**
   - [ ] 地區乘數
   - [ ] 適用法規
   - [ ] 地震、地質、環保風險
   - [ ] 勞工情況

6. **提取系統特性**
   - [ ] MEP 複雜度
   - [ ] 特殊系統
   - [ ] 系統溢價

7. **提取風險特性**
   - [ ] 複雜度評分 (8-16 分)
   - [ ] 複雜度乘數
   - [ ] 風險評分

**輸出**: 新項目特性檔案 (YAML 格式)

---

### Phase 2: 案例庫查詢

**目標**: 從案例庫中找出所有相似案例

**步驟**:

1. **按建築類型篩選**
   - 查詢案例庫中所有相同或相似建築類型的案例
   - 例如: 如果新項目是 Healthcare，查詢所有 Healthcare 案例

2. **按地區篩選** (可選)
   - 查詢相同或相鄰地區的案例
   - 例如: 如果新項目在 CA，優先查詢 CA 案例

3. **初步篩選結果**
   - 至少應該有 3-5 個初步候選案例
   - 如果少於 3 個，擴大篩選範圍

**輸出**: 初步候選案例清單 (5-10 個案例)

---

### Phase 3: 相似度計算

**目標**: 計算新項目與每個候選案例的相似度評分

**步驟**:

1. **對每個候選案例計算相似度**
   - 使用 LAYER 3.2 的相似度公式
   - 計算 6 個維度的相似度
   - 計算總體相似度評分 (0-100%)

2. **排序候選案例**
   - 按相似度評分從高到低排序
   - 識別 Top 3 最相似案例

3. **確定置信度等級**
   - 根據最高相似度評分確定置信度等級
   - VERY HIGH (≥85%) / HIGH (70-85%) / MEDIUM (55-70%) / LOW (<55%)

**輸出**: 排序的候選案例清單 + 置信度等級

---

### Phase 4: 根據置信度等級選擇估算策略

**目標**: 根據置信度等級選擇合適的估算策略

**Step 4a: 置信度 VERY HIGH (≥85%)**

**特徵**: 新項目與最相似案例在所有維度上都非常相似

**策略**:
1. 使用最相似案例作為基準
2. 應用微調整因子 (±5%)
3. 直接生成估算

**流程**:
```
基準成本/SF = 最相似案例的成本/SF
調整因子 = 應用 LAYER 3.3 的 6 個調整因子
最終成本/SF = 基準成本/SF × 調整因子
```

**置信度**: 95%+

---

**Step 4b: 置信度 HIGH (70-85%)**

**特徵**: 新項目與最相似案例在大多數維度上相似，但存在某些差異

**策略**:
1. 使用最相似案例作為基準
2. 應用調整因子 (±10-15%)
3. 需要 GC double check

**流程**:
```
基準成本/SF = 最相似案例的成本/SF
調整因子 = 應用 LAYER 3.3 的 6 個調整因子
最終成本/SF = 基準成本/SF × 調整因子
置信度範圍 = 最終成本/SF × (0.85-1.15)
```

**置信度**: 85-95%

**GC Double Check 項目**:
- [ ] 確認參考案例的相似性
- [ ] 驗證差異點的影響
- [ ] 確認調整因子的合理性
- [ ] 提供反饋和修正

---

**Step 4c: 置信度 MEDIUM (55-70%)**

**特徵**: 新項目與案例庫中的案例存在中等程度的差異

**策略**:
1. 使用 Top 3 最相似案例的成本/SF 進行平均
2. 應用調整因子 (±20-30%)
3. 需要詳細 GC double check

**流程**:
```
基準成本/SF = (案例1成本/SF + 案例2成本/SF + 案例3成本/SF) / 3
調整因子 = 應用 LAYER 3.3 的 6 個調整因子
最終成本/SF = 基準成本/SF × 調整因子
置信度範圍 = 最終成本/SF × (0.70-1.30)
```

**置信度**: 70-85%

**GC Double Check 項目**:
- [ ] 呈現 Top 3 最相似案例
- [ ] 解釋為什麼選擇這些案例
- [ ] 詳細說明差異點和調整因子
- [ ] 討論不確定性和風險
- [ ] 獲取 GC 的詳細反饋

---

**Step 4d: 置信度 LOW (<55%)**

**特徵**: 新項目與案例庫中的案例差異很大，無法找到充分相似的參考案例

**策略**:
1. 使用 LAYER 1 核心估算引擎
2. 參考 LAYER 2 領域特定知識
3. 需要詳細 GC double check + 現場評估

**流程**:
```
基準成本/SF = 使用 LAYER 1 核心估算引擎計算
調整因子 = 應用 LAYER 2 地區調整、複雜度乘數等
最終成本/SF = 基準成本/SF × 調整因子
置信度範圍 = 最終成本/SF × (0.60-1.40)
```

**置信度**: 60-75%

**GC Double Check 項目**:
- [ ] 解釋為什麼無法找到相似案例
- [ ] 呈現 LAYER 1 核心估算結果
- [ ] 詳細說明所有假設和調整
- [ ] 識別主要風險和不確定性
- [ ] 建議進行現場評估或詳細設計審查
- [ ] 獲取 GC 的詳細反饋和修正

---

### Phase 5: 應用調整因子

**目標**: 根據新項目與參考案例的差異應用調整因子

**步驟**:

1. **按順序應用 6 個調整因子**
   - Step 1: 建築類型調整
   - Step 2: 地區調整
   - Step 3: 規模調整
   - Step 4: 工期調整
   - Step 5: 改造強度調整
   - Step 6: 複雜度調整

2. **計算淨調整因子**
   ```
   淨調整因子 = 因子1 × 因子2 × 因子3 × 因子4 × 因子5 × 因子6
   ```

3. **驗證淨調整因子**
   - [ ] 淨調整因子在合理範圍內 (0.5x - 3.0x)
   - [ ] 每個調整因子都有明確的理由
   - [ ] 調整後成本與參考案例的差異可以解釋

**輸出**: 調整後的成本/SF

---

### Phase 6: 生成初步估算 (Updated v1.1)

**目標**: 生成新項目的初步成本估算 (Hard/Soft 架構)

**步驟**:

1. **計算 Hard Costs (營建成本)**
   - **Trade Costs**: `調整後成本/SF × 建築面積`
   - **General Conditions (Div 01)**: `Monthly Burn Rate × 工期 (月)`
   - **Insurance/Bonds**: `(Trade + Div 01) × 費率 (約 1.5%)`
   - **Total Hard Cost**: 上述三項之和

2. **計算 Soft Costs (費用與預留)**
   - **Contractor Fee**: `Total Hard Cost × Fee % (5-8%)`
   - **Contingency**: `(Total Hard Cost + Fee) × Contingency %`
   - **Total Soft Cost**: Fee + Contingency
   ```

3. **計算利潤/費用**
   ```
   利潤/費用 = 硬成本 × 利潤比例
   ```

4. **計算應急預留**
   ```
   應急預留 = (硬成本 + 軟成本) × 應急比例
   ```

5. **計算總成本**
   ```
   總成本 = 硬成本 + 軟成本 + 利潤/費用 + 應急預留
   ```

**輸出**: 初步成本估算

---

### Phase 7: 執行 Sanity Check

**目標**: 驗證初步估算的合理性

**步驟**:

1. **成本/SF 檢查**
   - 最終成本/SF 是否在合理範圍內？
   - 與參考案例的差異是否可以解釋？

2. **成本結構檢查**
   - 各成本分類的百分比是否合理？
   - 直接成本 + 間接成本 + 軟成本 + 利潤 + 應急 ≈ 100%？

3. **複雜度檢查**
   - 複雜度乘數是否已正確應用？
   - 複雜度評分是否與項目特性一致？

4. **風險檢查**
   - 應急預留是否充分？
   - 主要風險是否已識別？

**輸出**: Sanity Check 結果 (通過/失敗)

---

### Phase 8: 生成 GC Double Check 清單

**目標**: 準備與 GC 進行驗證的清單

**步驟**:

1. **根據置信度等級生成清單**
   - VERY HIGH: 最小清單 (可選 double check)
   - HIGH: 標準清單 (必需 double check)
   - MEDIUM: 詳細清單 (詳細 double check)
   - LOW: 完整清單 (詳細 double check + 現場評估)

2. **清單內容**
   - 參考案例信息
   - 相似度評分和置信度等級
   - 差異點說明
   - 調整因子詳解
   - 最終估算結果
   - 風險識別
   - 建議和建議

**輸出**: GC Double Check 清單

---

### Phase 9: 與 GC 進行 Double Check

**目標**: 與 GC 驗證估算結果

**步驟**:

1. **呈現估算結果**
   - 展示參考案例和相似度評分
   - 解釋調整因子和估算邏輯
   - 呈現最終估算結果

2. **收集 GC 反饋**
   - [ ] GC 是否同意參考案例的選擇？
   - [ ] GC 是否同意調整因子？
   - [ ] GC 是否有其他信息或修正？
   - [ ] GC 是否同意最終估算？

3. **根據反饋進行調整**
   - 如果 GC 提供了新信息，更新特性
   - 重新計算相似度和調整因子
   - 生成修訂的估算

**輸出**: GC 驗證的最終估算

---

## 置信度等級的估算策略

### 策略總結表

| 置信度等級 | 相似度 | 參考案例 | 調整因子 | GC Double Check | 置信度 |
|----------|--------|---------|---------|-----------------|--------|
| **VERY HIGH** | ≥85% | 1 個 | ±5% | 可選 | 95%+ |
| **HIGH** | 70-85% | 1 個 | ±10-15% | 必需 | 85-95% |
| **MEDIUM** | 55-70% | 3 個平均 | ±20-30% | 詳細 | 70-85% |
| **LOW** | <55% | LAYER 1 | ±30-50% | 詳細+現場 | 60-75% |

---

## 流程圖

### 完整估算流程圖

```
開始
  ↓
[Phase 1] 新項目特性提取
  ↓
[Phase 2] 案例庫查詢 (按建築類型篩選)
  ↓
[Phase 3] 相似度計算
  ↓
[Phase 4] 置信度等級判斷
  ├─→ VERY HIGH (≥85%)
  │   ├─→ 使用 1 個最相似案例
  │   ├─→ 應用微調整 (±5%)
  │   └─→ 生成估算
  │
  ├─→ HIGH (70-85%)
  │   ├─→ 使用 1 個最相似案例
  │   ├─→ 應用調整 (±10-15%)
  │   ├─→ 生成估算
  │   └─→ 需要 GC double check
  │
  ├─→ MEDIUM (55-70%)
  │   ├─→ 使用 Top 3 案例平均
  │   ├─→ 應用調整 (±20-30%)
  │   ├─→ 生成估算
  │   └─→ 需要詳細 GC double check
  │
  └─→ LOW (<55%)
      ├─→ 使用 LAYER 1 核心引擎
      ├─→ 應用 LAYER 2 知識
      ├─→ 生成估算
      └─→ 需要詳細 GC double check + 現場評估
  ↓
[Phase 5] 應用調整因子
  ├─→ 建築類型調整
  ├─→ 地區調整
  ├─→ 規模調整
  ├─→ 工期調整
  ├─→ 改造強度調整
  └─→ 複雜度調整
  ↓
[Phase 6] 生成初步估算
  ├─→ 計算直接成本
  ├─→ 計算間接成本
  ├─→ 計算軟成本
  ├─→ 計算利潤/費用
  ├─→ 計算應急預留
  └─→ 計算總成本
  ↓
[Phase 7] 執行 Sanity Check
  ├─→ 成本/SF 檢查 ✓
  ├─→ 成本結構檢查 ✓
  ├─→ 複雜度檢查 ✓
  └─→ 風險檢查 ✓
  ↓
[Phase 8] 生成 GC Double Check 清單
  ↓
[Phase 9] 與 GC 進行 Double Check
  ├─→ 呈現估算結果
  ├─→ 收集 GC 反饋
  └─→ 根據反饋調整
  ↓
完成 - 最終估算
```

---

## 實施檢查清單

### 完整檢查清單

#### Phase 1: 特性提取

- [ ] 收集了所有必需的項目文件
- [ ] 提取了基本特性 (名稱、類型、位置、面積、工期)
- [ ] 提取了改造特性 (如果適用)
- [ ] 提取了地區特性 (乘數、法規、風險)
- [ ] 提取了系統特性 (MEP 複雜度、特殊系統)
- [ ] 提取了風險特性 (複雜度評分、風險評分)

#### Phase 2: 案例庫查詢

- [ ] 按建築類型篩選了案例
- [ ] 至少找到 3-5 個初步候選案例
- [ ] 如果少於 3 個，已擴大篩選範圍

#### Phase 3: 相似度計算

- [ ] 計算了所有 6 個維度的相似度
- [ ] 計算了總體相似度評分
- [ ] 排序了候選案例
- [ ] 確定了置信度等級

#### Phase 4: 選擇估算策略

- [ ] 根據置信度等級選擇了合適的策略
- [ ] 確認了參考案例的選擇
- [ ] 確認了調整因子的應用範圍

#### Phase 5: 應用調整因子

- [ ] 按正確順序應用了 6 個調整因子
- [ ] 計算了淨調整因子
- [ ] 驗證了淨調整因子在合理範圍內

#### Phase 6: 生成初步估算

- [ ] 計算了直接成本
- [ ] 計算了間接成本
- [ ] 計算了軟成本
- [ ] 計算了利潤/費用
- [ ] 計算了應急預留
- [ ] 計算了總成本

#### Phase 7: Sanity Check

- [ ] 成本/SF 在合理範圍內
- [ ] 成本結構百分比合理
- [ ] 複雜度乘數正確應用
- [ ] 應急預留充分
- [ ] 所有檢查都通過

#### Phase 8: GC Double Check 清單

- [ ] 根據置信度等級生成了清單
- [ ] 清單包含了所有必需的信息
- [ ] 清單格式清晰易讀

#### Phase 9: GC Double Check

- [ ] 與 GC 進行了驗證
- [ ] 收集了 GC 反饋
- [ ] 根據反饋進行了調整 (如需要)
- [ ] 獲得了 GC 的最終批准

---

**END OF LAYER 3.4: CASE-BASED ESTIMATION LOGIC v1.0 (PRODUCTION)**
